<!DOCTYPE html> 
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Kiwoom 거래대금상위종목 조회</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 2px;
            text-align: center;
        }
        th {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="timestamp"></div>
    <div id="output"></div>

    <script>
        const stockInfoList = []; // 이 부분은 그대로 두거나, 필요한 경우 로드하세요.

        const accessParams = {
            grant_type: 'client_credentials',
            // GitHub Actions에서 치환될 플레이스홀더 사용
            appkey: 'APP_KEY_PLACEHOLDER',
            secretkey: 'APP_SECRET_PLACEHOLDER',
        };

        const chartParams = {
            mrkt_tp: '000',// 시장구분 000:전체, 001:코스피, 101:코스닥
            mang_stk_incls: '1',// 관리종목포함 0:관리종목 미포함, 1:관리종목 포함
            stex_tp: '3',// 거래소구분 1:KRX, 2:NXT 3.통합
        };

        async function fetchToken() {
            const url = 'https://mockapi.kiwoom.com/oauth2/token';
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                body: JSON.stringify(accessParams)
            });
            const data = await res.json();
            return data.token;
        }

        async function fetchTopStocks(token) {
            const url = 'https://mockapi.kiwoom.com/api/dostk/rkinfo';
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=UTF-8',
                    'authorization': `Bearer ${token}`,
                    'api-id': 'ka10032',
                    'cont-yn': 'N',
                    'next-key': ''
                },
                body: JSON.stringify(chartParams)
            });
            const data = await res.json();
            return data.trde_prica_upper || [];
        }

        async function fetchSectorRates(token) {
            const indsList = ['001', '101']; // 업종코드 001:종합(KOSPI), 101:종합(KOSDAQ)
            const sectorRates = {};

            for (let inds_cd of indsList) {
                const res = await fetch('https://mockapi.kiwoom.com/api/dostk/sect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json;charset=UTF-8',
                        'authorization': `Bearer ${token}`,
                        'api-id': 'ka20003',
                        'cont-yn': 'N',
                        'next-key': '',
                    },
                    body: JSON.stringify({ inds_cd })
                });
                const data = await res.json();
                (data.all_inds_idex || []).forEach(item => {
                    sectorRates[item.stk_cd] = item.flu_rt;
                });
            }
            return sectorRates;
        }

        function renderTable(dataList) {
            function generateRows(items) {
                return items.map(item => `
                    <tr>
                        <td>${item.stk_cd}</td>
                        <td>${item.stk_nm}</td>
                        <td>${item.cur_prc}</td>
                        <td>${item.flu_rt}</td>
                        <td>${item.trde_prica ? parseInt(item.trde_prica).toLocaleString() : '-'}</td>
                        <td>${item.시가총액 || '-'}</td>
                    </tr>
                `).join('');
            }

            const headers = `
                <thead>
                    <tr>
                        <th>종목코드</th>
                        <th>종목명</th>
                        <th>현재가</th>
                        <th>등락률</th>
                        <th>거래대금(백만원)</th>
                        <td>시가총액</td>
                    </tr>
                </thead>
            `;

            const firstHalf = dataList.slice(0, 50);
            const secondHalf = dataList.slice(50);

            let html = `
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <table>${headers}<tbody>${generateRows(firstHalf)}</tbody></table>
                    </div>
                    <div style="flex: 1;">
                        <table>${headers}<tbody>${generateRows(secondHalf)}</tbody></table>
                    </div>
                </div>
            `;

            document.getElementById('output').innerHTML = html;
        }

        async function updateData() {
            try {
                document.getElementById('output').innerText = '데이터 불러오는 중...';
                const token = await fetchToken();
                const [stockList, sectorRates] = await Promise.all([
                    fetchTopStocks(token),
                    fetchSectorRates(token)
                ]);

                const merged = stockList.map(item => {
                    const code = item.stk_cd.split('_')[0];
                    const info = stockInfoList.find(x => x.종목코드 === code) || {};

                    const 유통시총 = info.유통시총 != null
                        ? parseFloat(info.유통시총)
                        : (info.시가총액 && info.유통비율
                            ? parseFloat(info.시가총액) * parseFloat(info.유통비율)
                            : null);

                    return {
                        stk_cd: code,
                        now_rank: item.now_rank,
                        stk_nm: item.stk_nm,
                        flu_rt: item.flu_rt,
                        cur_prc: Math.abs(item.cur_prc),
                        trde_prica: item.trde_prica,
                        시가총액: info.시가총액,
                        유통비율: info.유통비율,
                        유통시총: 유통시총,
                    };
                });

                renderTable(merged);
            } catch (e) {
                document.getElementById('output').innerText = '에러 발생: ' + e.message;
            }
        }

        updateData();
        setInterval(updateData, 10000);
    </script>
</body>
</html>
