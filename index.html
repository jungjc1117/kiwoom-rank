<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Kiwoom 거래대금상위종목 조회</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Kiwoom 거래대금상위종목 조회 (30초마다 갱신)</h1>
    <div id="timestamp"></div>
    <div id="output"></div>

    <script>
        // CSV 데이터를 JS 객체로 직접 포함
        const infoData = [
            {"시장": "K", "업종구분": "증권", "종목명": "키움증권", "종목코드": "039490", "시가총액": "47730", "유통비율": "52", "업종코드": "024"},
            {"시장": "K", "업종구분": "일반서비스", "종목명": "AJ네트웍스", "종목코드": "095570", "시가총액": "1760", "유통비율": "43", "업종코드": "026"},
            {"시장": "K", "업종구분": "금융", "종목명": "AK홀딩스", "종목코드": "006840", "시가총액": "1517", "유통비율": "33", "업종코드": "021"},
            {"시장": "K", "업종구분": "금융", "종목명": "BGF", "종목코드": "027410", "시가총액": "4087", "유통비율": "30", "업종코드": "021"}
            // ... 추가 데이터
        ];

        // 종목코드 기준 Map으로 빠른 조회
        const infoMap = new Map();
        infoData.forEach(record => {
            infoMap.set(record["종목코드"], record);
        });

        // 기타 API 파라미터
        const accessParams = {
            grant_type: 'client_credentials',
            appkey: 'pdttv1FeGLioCvpIK63wRIwSGNORSGKI9juDChFzuMA',
            secretkey: 'bYQBCB1IieM972uJZxVPNBWKEIGd1kTMx-PbCnB-L58',
        };

        const chartParams = {
            mrkt_tp: '001',
            mang_stk_incls: '1',
            stex_tp: '3',
        };

        // 토큰, 데이터 fetch 함수들
        async function fetchToken() {
            const res = await fetch('https://mockapi.kiwoom.com/oauth2/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                body: JSON.stringify(accessParams)
            });
            const json = await res.json();
            return json.token;
        }

        async function fetchTopStocks(token) {
            const res = await fetch('https://mockapi.kiwoom.com/api/dostk/rkinfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=UTF-8',
                    'authorization': `Bearer ${token}`,
                    'cont-yn': 'N',
                    'next-key': '',
                    'api-id': 'ka10032',
                },
                body: JSON.stringify(chartParams)
            });
            const json = await res.json();
            return json.trde_prica_upper || [];
        }

        // 일정 시간 대기
        function delay(ms) {
            return new Promise(res => setTimeout(res, ms));
        }

        function renderTable(dataList) {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>종목코드</th>
                            <th>순위</th>
                            <th>종목명</th>
                            <th>등락률</th>
                            <th>거래대금</th>
                            <th>시장</th>
                            <th>업종구분</th>
                            <th>시가총액</th>
                            <th>유통비율</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            dataList.forEach(item => {
                const info = infoMap.get(item.stk_cd) || {};
                html += `
                    <tr>
                        <td>${item.stk_cd}</td>
                        <td>${item.now_rank}</td>
                        <td>${item.stk_nm}</td>
                        <td>${item.flu_rt}</td>
                        <td>${parseInt(item.trde_prica).toLocaleString()}</td>
                        <td>${info["시장"] || '-'}</td>
                        <td>${info["업종구분"] || '-'}</td>
                        <td>${info["시가총액"] || '-'}</td>
                        <td>${info["유통비율"] || '-'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('output').innerHTML = html;
            document.getElementById('timestamp').textContent = `[업데이트 시각] ${new Date().toLocaleTimeString()}`;
        }

        async function updateData() {
            try {
                document.getElementById('output').innerText = '데이터 불러오는 중...';
                const token = await fetchToken();
                const topList = await fetchTopStocks(token);
                const merged = [];

                for (let item of topList) {
                    const code = item.stk_cd.split('_')[0];
                    merged.push({
                        stk_cd: code,
                        now_rank: item.now_rank,
                        stk_nm: item.stk_nm,
                        flu_rt: item.flu_rt,
                        trde_prica: item.trde_prica,
                    });
                }

                renderTable(merged);
            } catch (e) {
                document.getElementById('output').innerText = '에러: ' + e.message;
            }
        }

        updateData();
        setInterval(updateData, 5000);
    </script>
</body>
</html>
